{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Generate Hike Letter - {{ employee.first_name }} {{ employee.last_name }}</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        body {font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);margin:0;padding:20px;min-height:100vh;color:#333}
        .container{max-width:680px;margin:40px auto;background:white;border-radius:20px;box-shadow:0 15px 40px rgba(0,0,0,0.2);overflow:hidden}
        .header{background:linear-gradient(135deg,#004080,#0077be);color:white;padding:35px;text-align:center}
        h2{margin:0;font-size:28px;font-weight:600}
        .info{margin:10px 0;font-size:17px;opacity:0.95}
        .body{padding:40px 50px}
        .info-grid{display:grid;grid-template-columns:max-content 1fr;gap:12px 20px;background:#f0f8ff;padding:22px;border-radius:12px;margin-bottom:25px;font-size:16px;border-left:6px solid #004080}
        .info-grid strong{color:#004080;font-weight:600}
        label{display:block;margin-top:22px;font-weight:600;font-size:16px}
        input[type=date],input[type=number]{width:100%;padding:14px;margin-top:8px;border:2px solid #e0e0e0;border-radius:10px;font-size:16px;transition:all .3s}
        input:focus{outline:none;border-color:#004080;box-shadow:0 0 12px rgba(0,64,128,.25)}
        .annual-box{margin-top:18px;padding:22px;background:linear-gradient(135deg,#e6f7ff,#d4edff);border:2px dashed #004080;border-radius:12px;text-align:center;font-size:26px;font-weight:bold;color:#004080}
        button{margin-top:35px;width:100%;padding:18px;background:#004080;color:white;border:none;border-radius:12px;font-size:19px;font-weight:bold;cursor:pointer;transition:.3s}
        button:hover{background:#003060;transform:translateY(-2px)}
        .back-link{display:block;text-align:center;margin-top:30px;color:#004080;font-weight:bold;text-decoration:none;font-size:16px}
        .back-link:hover{text-decoration:underline}
        .warning-box{background:#fff8e1;color:#b37400;padding:18px;border-radius:12px;margin:20px 0;border-left:6px solid #ffc107;font-size:15px}
        .error-message{background:#ffebee;color:#c62828;padding:16px;border-radius:10px;margin:15px 0;border-left:5px solid #f44336;font-weight:500}
        .download-section{margin:40px 0;text-align:center}
        .download-btn{display:inline-block;background:#006400;color:white;padding:18px 50px;border-radius:15px;text-decoration:none;font-weight:bold;font-size:22px;box-shadow:0 10px 30px rgba(0,100,0,.35);transition:all .3s}
        .download-btn:hover{background:#004d00;transform:translateY(-4px);box-shadow:0 15px 40px rgba(0,100,0,.5)}
        .download-info{margin-top:15px;color:#006400;font-size:16px;font-weight:500}
        .missing-file{background:#ffebee;border-left:6px solid #f44336;color:#c62828;padding:25px;border-radius:15px;text-align:center;margin:30px 0}
        .note{font-size:14px;color:#555;margin-top:8px;font-style:italic}
    </style>
</head>
<body>
{% include 'includes/navbar.html' %}

<div class="container">
    <div class="header">
        <h2>Generate Hike Letter</h2>
        <div class="info"><strong>{{ employee.first_name }} {{ employee.last_name }}</strong></div>
        <div class="info">{{ employee.designation|default:"—" }} • {{ employee.department|default:"—" }}</div>
    </div>

    <div class="body">

        {% if messages %}
            {% for message in messages %}
                <div class="error-message">{{ message }}</div>
            {% endfor %}
        {% endif %}

        {% if error_message %}
            <div class="error-message">{{ error_message }}</div>
        {% endif %}

        <div class="info-grid">
            <strong>Employee Name:</strong> <span>{{ employee.get_full_name }}</span>
            <strong>Current CTC (Annual):</strong>
                <span style="color:#d00; font-weight:bold;">₹{{ old_package|floatformat:0 }}</span>
            <strong>Original Joining Date:</strong>
                <span style="color:#c00; font-weight:bold;">
                    {{ min_date|date:"d F Y" }}
                </span>
        </div>

        <div class="warning-box">
            <strong>Important:</strong> Hike letter date <strong>cannot</strong> be before the original joining date shown above.<br>
            Hike will be effective from the <strong>1st of next month</strong> after the selected date.
        </div>

        <!-- Existing Hike Letter -->
        {% if hike_letter_obj and file_exists %}
            <div class="download-section">
                <div class="warning-box">
                    A hike letter already exists.<br>
                    <em>Regenerating will <strong>replace</strong> the old file.</em>
                </div>
                <a href="{{ hike_letter_obj.hike_letter_file.url }}" target="_blank" class="download-btn">
                    <i class="fas fa-download"></i> Download Existing Hike Letter
                </a>
                <p class="download-info">
                    Generated on {{ hike_letter_obj.date|date:"d M Y" }} 
                    → New CTC: ₹{{ hike_letter_obj.new_package|floatformat:0 }}
                </p>
            </div>
        {% elif hike_letter_obj %}
            <div class="missing-file">
                <h4>Document Missing</h4>
                <p>Hike letter record exists ({{ hike_letter_obj.date|date:"d M Y" }}),<br>
                   but the file is missing from server.</p>
                <p><strong>Regenerate below to restore it.</strong></p>
            </div>
        {% endif %}

        <!-- Form -->
        <form method="POST">
            {% csrf_token %}

            <label for="date">
                Hike Letter Date <small style="color:#004080;">(Hike starts from next month)</small>
            </label>
            <input type="date"
                   name="date"
                   id="date"
                   required
                   min="{{ min_date|date:'Y-m-d' }}"
                   value="{% now 'Y-m-d' %}">

            <div class="note">
                Hike will be effective from the <strong>1st of next month</strong> after the selected date.
            </div>

            <label for="new_package_month">New Monthly CTC (₹)</label>
            <input type="number"
                   step="1000"
                   min="10000"
                   name="new_package_month"
                   id="new_package_month"
                   placeholder="e.g. 85000"
                   required
                   oninput="calculateAnnual()">

            <div class="annual-box">
                New Annual CTC: ₹ <span id="new_package_annual_display">0</span>
            </div>

            <input type="hidden" name="new_package_annual" id="new_package_annual_input" value="0">

            <button type="submit">
                {% if hike_letter_obj %}Regenerate{% else %}Generate{% endif %} Hike Letter
            </button>
        </form>

        <a href="{% url 'employees:employee_list' %}" class="back-link">
            ← Back to Employee List
        </a>
    </div>
</div>

<script>
    // === Annual CTC Calculator ===
    function calculateAnnual() {
        const monthly = parseFloat(document.getElementById('new_package_month').value) || 0;
        const annual = monthly * 12;
        const formatted = annual.toLocaleString('en-IN', { minimumFractionDigits: 0, maximumFractionDigits: 0 });
        document.getElementById('new_package_annual_display').textContent = formatted;
        document.getElementById('new_package_annual_input').value = annual.toFixed(2);
    }

    // === Robust Past Date Blocker (Same as your trusted version) ===
    const dateInput = document.getElementById('date');
    const MIN_DATE_STR = "{{ min_date|date:'Y-m-d' }}";

    function blockPastDate() {
        if (MIN_DATE_STR && dateInput.value && dateInput.value < MIN_DATE_STR) {
            alert("Hike date cannot be before original joining date: " + 
                  new Date(MIN_DATE_STR).toLocaleDateString('en-IN', {
                      day: 'numeric',
                      month: 'long',
                      year: 'numeric'
                  }));
            dateInput.value = new Date().toISOString().split('T')[0];  // Today
        }
    }

    // Initialize
    window.addEventListener('load', function() {
        calculateAnnual();
        blockPastDate();
    });

    // Real-time updates
    document.getElementById('new_package_month').addEventListener('input', calculateAnnual);
    dateInput.addEventListener('change', blockPastDate);
    dateInput.addEventListener('input', blockPastDate);
    dateInput.addEventListener('blur', blockPastDate);
</script>

</body>
</html>